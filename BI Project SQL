CREATE SCHEMA star;

CREATE TABLE star.DimProduct (
product_id INT PRIMARY KEY,
product_name VARCHAR(50),
category VARCHAR(50),
brand VARCHAR(50),
price_unit DECIMAL(10,2)
);
INSERT INTO star.DimProduct (product_id, product_name, category, brand, price_unit) VALUES
(1,'delicious cookies','bakery','fantastic company',12.95),
(2,'flauschi','hygiene','company 2',5.11),
(3,'smelly','cosmetics','smells nice',7.77);

CREATE TABLE star.DimLocation (
location_id INT PRIMARY KEY,
location_name VARCHAR(29),
city VARCHAR(50)
);
INSERT INTO star.DimLocation (location_id, location_name, city) VALUES
(1,'city central','Berlin'),
(2,'outer city','Berlin'),
(3,'central','London'),
(4,'westside','Madrid'),
(5,'east','Rome');

CREATE TABLE star.DimSeller(
seller_id INT PRIMARY KEY,
prename VARCHAR(50),
surname VARCHAR(59),
employee_no INT
);
INSERT INTO star.DimSeller (seller_id, prename, surname, employee_no) VALUES
(1,'Max','Mustermann',1234),
(2,'John','Smith',2345),
(3,'Somebody','Else',9876);

CREATE TABLE star.DimDate (
date_id INT PRIMARY KEY,
datetime TIMESTAMP,
weekday INT GENERATED ALWAYS AS (
	CASE
		WHEN EXTRACT (DOW FROM datetime)=0 THEN 7
		ELSE EXTRACT (DOW FROM datetime)
	END
)STORED,
month INT GENERATED ALWAYS AS (EXTRACT(MONTH FROM datetime))STORED,
year INT GENERATED ALWAYS AS (EXTRACT (YEAR FROM datetime))STORED,
time TIME GENERATED ALWAYS AS (datetime::time)STORED,
calendarweek INT GENERATED ALWAYS AS(EXTRACT(WEEK FROM datetime))STORED
);

INSERT INTO star.dimdate(date_id, datetime) VALUES
(1, '2025-07-18 22:00:00'),
(2, '2022-11-01 20:12:13'),
(3, '2024-12-24 20:11:12');

CREATE TABLE star.DimPayment(
payment_id INT PRIMARY KEY,
payment_method VARCHAR(50),
card_type VARCHAR(30),
card_number INT
);
INSERT INTO star.dimpayment(payment_id, payment_method, card_type, card_number) VALUES
(1, 'bar',NULL,NULL),
(2, 'card', 'master card','123456789'),
(3, 'card', 'visa','234567891');

CREATE TABLE star.FactReceipt(
receipt_id INT PRIMARY KEY,
date_id INT,
location_id INT,
tax_rate DECIMAL (10,2),
payment_id INT,
seller_id INT,
currency VARCHAR(3),
FOREIGN KEY (date_id) REFERENCES star.DimDate(date_id),
FOREIGN KEY (location_id) REFERENCES star.DimLocation(location_id),
FOREIGN KEY (payment_id) REFERENCES star.DimPayment(payment_id),
FOREIGN KEY (seller_id) REFERENCES star.DimSeller(seller_id));

INSERT INTO star.factreceipt (receipt_id, date_id, location_id, tax_rate, payment_id, seller_id, currency) VALUES 
(1,1,1,7,1,1,'EUR'),
(2,2,1,19,2,1,'EUR'),
(3,1,2,7,2,2,'EUR');

CREATE TABLE star.LinkProductReceipt(
link_key INT PRIMARY KEY,
product_id INT,
receipt_id INT,
quantity INT,
FOREIGN KEY (product_id) REFERENCES star.dimproduct(product_id),
FOREIGN KEY (receipt_id) REFERENCES star.factreceipt(receipt_id)
);

INSERT INTO star.linkproductreceipt(link_key, product_id, receipt_id, quantity)
VALUES
(1,1,1,3),
(2,2,1,1),
(3,3,2,2),
(4,1,3,1);

CREATE SCHEMA vault;

CREATE TABLE vault.HubProduct (
hk_product VARCHAR(50) PRIMARY KEY NOT NULL,
product_id INT NOT NULL,
load_date TIMESTAMP NOT NULL,
record_source VARCHAR(50) NOT NULL
);
INSERT INTO vault.hubproduct (
hk_product,
product_id,
load_date,
record_source
) SELECT DISTINCT 
MD5(CAST(product_id AS TEXT)),
product_id,
CURRENT_TIMESTAMP(0),
'star.dimproduct'
from star.dimproduct;

CREATE TABLE vault.SatProductPrice (
hk_product VARCHAR(50) NOT NULL,
load_date TIMESTAMP NOT NULL,
load_dateend TIMESTAMP,
load_source VARCHAR(100) NOT NULL,
price DECIMAL(10,2),
CONSTRAINT s_productprice
	PRIMARY KEY (hk_product, load_date),
CONSTRAINT s_productprice_h_product_fk
	FOREIGN KEY (hk_product)
	references vault.hubproduct(hk_product)
);
INSERT INTO vault.satproductprice (
hk_product,
load_date,
load_source,
price
) SELECT DISTINCT 
MD5(CAST(product_id AS TEXT)),
CURRENT_TIMESTAMP(0),
'star.dimproduct',
price_unit
from star.dimproduct;

CREATE TABLE vault.SatProduct (
hk_product VARCHAR(50) NOT NULL,
load_date TIMESTAMP NOT NULL,
loadend_date TIMESTAMP,
load_source VARCHAR(100) NOT NULL,
product_name VARCHAR(50) NOT NULL,
category VARCHAR(50) NOT NULL,
brand VARCHAR(50) NOT NULL,
CONSTRAINT s_satproduct
	PRIMARY KEY (hk_product, load_date),
CONSTRAINT s_satproduct_h_product_fk
	FOREIGN KEY (hk_product)
	REFERENCES vault.hubproduct(hk_product)
);
INSERT INTO vault.satproduct (
hk_product,
load_date,
load_source,
product_name,
category,
brand
) SELECT DISTINCT 
MD5(CAST(product_id AS TEXT)),
CURRENT_TIMESTAMP(0),
'star.dimproduct',
product_name,
category,
brand
from star.dimproduct;

CREATE TABLE vault.HubPayment (
hk_payment VARCHAR(50) NOT NULL PRIMARY KEY,
payment_id INTEGER NOT NULL,
load_date TIMESTAMP NOT NULL,
record_source VARCHAR(100) NOT NULL
);
INSERT INTO vault.hubpayment(
hk_payment,
payment_id,
load_date,
record_source
) SELECT DISTINCT
MD5(CAST(payment_id AS TEXT)),
payment_id,
CURRENT_TIMESTAMP(0),
'star.dimpayment'
FROM star.dimpayment;

CREATE TABLE vault.satpayment(
hk_payment VARCHAR(50) NOT NULL,
load_date TIMESTAMP NOT NULL,
loadend_date TIMESTAMP,
load_source VARCHAR(100),
payment_method VARCHAR(50) NOT NULL,
card_type VARCHAR(30),
card_number INTEGER,
CONSTRAINT s_satpayment
	PRIMARY KEY (hk_payment,load_date),
CONSTRAINT s_satpayment_h_hubpayment
	FOREIGN KEY (hk_payment)
	REFERENCES vault.hubpayment(hk_payment)
);

INSERT INTO vault.satpayment(
hk_payment,
load_date,
load_source,
payment_method,
card_type,
card_number)
SELECT DISTINCT
MD5(CAST(payment_id AS TEXT)),
CURRENT_TIMESTAMP(0),
'star.dimpayment',
payment_method,
card_type,
card_number
FROM star.dimpayment;

CREATE TABLE vault.hublocation (
hk_location VARCHAR(50) NOT NULL PRIMARY KEY,
location_id INTEGER NOT NULL,
load_date TIMESTAMP NOT NULL,
record_source VARCHAR(100) NOT NULL
);
INSERT INTO vault.hublocation (
hk_location,
location_id,
load_date,
record_source)
SELECT DISTINCT
MD5(CAST(location_id AS TEXT)),
location_id,
CURRENT_TIMESTAMP(0),
'star.dimlocation'
FROM star.dimlocation;

CREATE TABLE vault.satlocation(
hk_location VARCHAR(50) NOT NULL,
load_date TIMESTAMP NOT NULL,
loadend_date TIMESTAMP,
load_source VARCHAR(100) NOT NULL,
location_name VARCHAR(59) NOT NULL,
city VARCHAR(50) NOT NULL,
CONSTRAINT s_satlocation
	PRIMARY KEY (hk_location, load_date),
CONSTRAINT s_satlocation_h_hublocation
	FOREIGN KEY (hk_location)
	REFERENCES vault.hublocation(hk_location)
);

INSERT INTO vault.satlocation(
hk_location,
load_date,
load_source,
location_name,
city)
SELECT DISTINCT
MD5(CAST(location_id AS TEXT)),
CURRENT_TIMESTAMP(0),
'star.dimlocation',
location_name,
city
FROM star.dimlocation;

CREATE TABLE vault.hubseller(
hk_seller VARCHAR(50) NOT NULL PRIMARY KEY,
seller_id INTEGER NOT NULL,
load_date TIMESTAMP NOT NULL,
record_source VARCHAR(50) NOT NULL
);
INSERT INTO vault.hubseller(
hk_seller,
seller_id,
load_date,
record_source)
SELECT DISTINCT
MD5(CAST(seller_id AS TEXT)),
seller_id,
CURRENT_TIMESTAMP(0),
'star.dimseller'
FROM star.dimseller;

CREATE TABLE vault.satseller(
hk_seller VARCHAR(50) NOT NULL,
load_date TIMESTAMP NOT NULL,
loadend_date TIMESTAMP,
load_source VARCHAR(50) NOT NULL,
prename VARCHAR(50) NOT NULL,
surname VARCHAR (50) NOT NULL,
employee_no INTEGER NOT NULL,
CONSTRAINT s_satseller
	PRIMARY KEY (hk_seller, load_date),
CONSTRAINT s_satseller_h_hubseller
	FOREIGN KEY (hk_seller)
	REFERENCES vault.hubseller(hk_seller)
);

INSERT INTO vault.satseller(
hk_seller,
load_date,
load_source,
prename,
surname,
employee_no
)
SELECT DISTINCT
MD5(CAST(seller_id AS TEXT)),
CURRENT_TIMESTAMP,
'star.dimseller',
prename,
surname,
employee_no
FROM star.dimseller;

CREATE TABLE vault.hubcart(
hk_cart VARCHAR(50) NOT NULL PRIMARY KEY,
cart_id INTEGER NOT NULL,
load_date TIMESTAMP NOT NULL,
record_source VARCHAR(100) NOT NULL
);
INSERT INTO vault.hubcart(
hk_cart,
cart_id,
load_date,
record_source)
SELECT DISTINCT
MD5(CAST(receipt_id AS TEXT)),
receipt_id,
CURRENT_TIMESTAMP,
'star.factreceipt'
FROM star.factreceipt;

CREATE TABLE vault.l_Cart(
hk_cart_total VARCHAR(200) NOT NULL PRIMARY KEY,
hk_cart VARCHAR(50) NOT NULL,
hk_payment VARCHAR(50) NOT NULL,
hk_location VARCHAR(50) NOT NULL,
hk_seller VARCHAR(50) NOT NULL,
load_date TIMESTAMP NOT NULL
);
INSERT INTO vault.l_cart(
hk_cart_total,
hk_cart,
hk_payment,
hk_location,
hk_seller,
load_date
) SELECT DISTINCT
MD5(CAST(receipt_id AS TEXT))||'|'
|| MD5(CAST(payment_id AS TEXT))||'|'
|| MD5(CAST(location_id AS TEXT))||'|'
|| MD5(CAST(seller_id AS TEXT)),
MD5(CAST(receipt_id AS TEXT)),
MD5(CAST(payment_id AS TEXT)),
MD5(CAST(location_id AS TEXT)),
MD5(CAST(seller_id AS TEXT)),
CURRENT_TIMESTAMP(0)
FROM star.factreceipt;

CREATE TABLE vault.l_CartProduct(
hk_cart_product VARCHAR(100) NOT NULL PRIMARY KEY,
hk_product VARCHAR(50) NOT NULL,
hk_cart VARCHAR(50) NOT NULL,
load_date TIMESTAMP NOT NULL,
CONSTRAINT l_cartproduct_h_hubcart
	FOREIGN KEY (hk_cart)
	REFERENCES vault.hubcart (hk_cart),
CONSTRAINT l_cartproduct_h_hubproduct
	FOREIGN KEY (hk_product)
	REFERENCES vault.hubproduct (hk_product)
);

INSERT INTO vault.l_cartproduct(
hk_cart_product,
hk_product,
hk_cart,
load_date
) SELECT DISTINCT
MD5(CAST(receipt_id AS TEXT))||'|'
||MD5(CAST(product_id as TEXT)),
MD5(CAST(product_id as TEXT)),
MD5(CAST(receipt_id AS TEXT)),
CURRENT_TIMESTAMP(0)
FROM star.linkproductreceipt;

CREATE TABLE vault.SatCartProduct(
hk_cart_product VARCHAR(100) NOT NULL,
load_date TIMESTAMP NOT NULL,
loadend_date TIMESTAMP,
record_source VARCHAR(50) NOT NULL,
num_products INTEGER NOT NULL,
CONSTRAINT s_satcartproduct
	PRIMARY KEY (hk_cart_product, load_date),
CONSTRAINT s_satcartproduct_l_cartproduct
	FOREIGN KEY (hk_cart_product)
	REFERENCES vault.l_cartproduct (hk_cart_product)
);

INSERT INTO vault.satcartproduct(
hk_cart_product,
load_date,
record_source,
num_products
)SELECT DISTINCT
MD5(CAST(receipt_id AS TEXT))||'|'
||MD5(CAST(product_id as TEXT)),
CURRENT_TIMESTAMP(0),
'star.linkproductreceipt',
quantity
FROM star.linkproductreceipt;

CREATE TABLE vault.SatCart(
hk_cart VARCHAR(50) NOT NULL,
load_date TIMESTAMP NOT NULL,
loadend_date TIMESTAMP,
record_source VARCHAR(50) NOT NULL,
tax_rate DECIMAL(10,2) NOT NULL,
currency VARCHAR(3) NOT NULL,
CONSTRAINT s_satcart
	PRIMARY KEY (hk_cart,load_date),
CONSTRAINT s_satcart_h_hubcart
	FOREIGN KEY (hk_cart)
	REFERENCES vault.hubcart(hk_cart)
);

INSERT INTO vault.satcart(
hk_cart,
load_date,
record_source,
tax_rate,
currency
)SELECT DISTINCT
MD5(CAST(receipt_id AS TEXT)),
CURRENT_TIMESTAMP(0),
'star.factreceipt',
tax_rate,
currency
FROM star.factreceipt;
